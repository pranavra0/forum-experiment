{{define "renderReplies"}}
  {{range .Replies}}
    <article class="reply" id="reply-{{.ID}}" style="
        border:1px solid var(--border);
        padding:0.5rem;
        margin:0.25rem 0;
        border-radius:0.25rem;
        font-size:0.85rem;
        background: rgba(26,26,28,0.5);
      ">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
        <strong style="color:var(--accent);">{{.Username}}</strong>
        <small style="color:var(--muted); font-size:0.75rem;">{{.FormattedTime}}</small>
        {{if $.User}}
        <button type="button" onclick="prefillReply({{.ID}}, '{{js .Username}}')" style="
            font-size:0.7rem;
            padding:0 3px;
            border:none;
            background:none;
            color: var(--accent);
            cursor:pointer;
          ">
          Reply
        </button>
        {{end}}
      </div>
      <p style="margin:0; line-height:1.3; white-space:pre-wrap;">{{parseQuotes .Content}}</p>
    </article>
  {{end}}
{{end}}

{{define "content"}}
{{with .Thread}}
<article class="thread" style="
    padding:0.5rem 0.75rem;
    border:1px solid var(--border);
    border-radius:0.25rem;
    margin-bottom:0.5rem;
    font-size:0.9rem;
  ">
  <h2 style="margin:0 0 0.25rem 0; font-size:1rem;">{{.Title}}</h2>
  <div style="color:var(--muted); font-size:0.75rem; margin-bottom:0.25rem;">
    Posted by <strong>{{.Username}}</strong> â€” {{.FormattedTime}}
  </div>
  <p style="margin:0; line-height:1.3;">{{.Content}}</p>
</article>
{{end}}

<section class="replies" style="margin-top:1rem;">
  <h3>Replies</h3>
  {{if .Replies}}
    <div style="display:flex; flex-direction:column; gap:0.5rem;">
      {{template "renderReplies" dict "Replies" .Replies "Level" 0 "User" .User}}
    </div>
  {{else}}
    <p>No replies yet.</p>
  {{end}}
</section>
{{if gt .Pagination.TotalPages 1}}
<nav style="display:flex; justify-content:center; gap:0.5rem; margin-top:1rem; font-size:0.85rem;">
  {{if .Pagination.HasPrev}}
    <a href="?page={{sub .Pagination.Page 1}}">Prev</a>
  {{end}}

  <a href="?page=1" {{if eq .Pagination.Page 1}}style="font-weight:bold;"{{end}}>1</a>

  {{if .Pagination.ShowStartEllipsis}}<span>...</span>{{end}}

  {{range .Pagination.Pages}}
    <a href="?page={{.}}" {{if eq $.Pagination.Page .}}style="font-weight:bold;"{{end}}>{{.}}</a>
  {{end}}

  {{if .Pagination.ShowEndEllipsis}}<span>...</span>{{end}}

  <a href="?page={{.Pagination.TotalPages}}" {{if eq .Pagination.Page .Pagination.TotalPages}}style="font-weight:bold;"{{end}}>{{.Pagination.TotalPages}}</a>

  {{if .Pagination.HasNext}}
    <a href="?page={{add .Pagination.Page 1}}">Next</a>
  {{end}}
</nav>
{{end}}

{{if .User}}
<form method="POST" action="/thread/{{.Thread.ID}}/reply" style="margin-top:2rem;">
  <input type="hidden" name="parent_id" id="parent_id" value="">
  
  <div id="replying-to" style="
        font-size: 0.8rem; 
        color: var(--accent); 
        margin-bottom: 0.25rem;
        display: none;
      ">
    Replying to <span id="replying-username"></span>
    <button type="button" onclick="clearReply()" style="
          font-size:0.7rem;
          color:var(--muted);
          background:none;
          border:none;
          cursor:pointer;
          margin-left:0.5rem;
        ">Cancel</button>
  </div>

  <textarea name="content" rows="4" placeholder="Write your reply..." required style="
        width:100%; padding:0.75rem; border:1px solid var(--border); background:var(--card); 
        color:var(--text); border-radius:0.25rem; resize:vertical;">
  </textarea>
  <button type="submit" style="margin-top:0.5rem;">Post Reply</button>
</form>
{{end}}

<script type="text/javascript">
function prefillReply(id, username) {
    const parentInput = document.getElementById('parent_id');
    const replyingDiv = document.getElementById('replying-to');
    const replyingUsername = document.getElementById('replying-username');
    const textarea = document.querySelector('textarea[name=content]');
    
    if (!parentInput || !replyingDiv || !replyingUsername || !textarea) return;

    parentInput.value = id;
    replyingUsername.textContent = username;
    replyingDiv.style.display = "block";

    textarea.focus();
    textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function clearReply() {
    const parentInput = document.getElementById('parent_id');
    const replyingDiv = document.getElementById('replying-to');
    const replyingUsername = document.getElementById('replying-username');

    if (!parentInput || !replyingDiv || !replyingUsername) return;

    parentInput.value = "";
    replyingUsername.textContent = "";
    replyingDiv.style.display = "none";
}
</script>
{{end}}
